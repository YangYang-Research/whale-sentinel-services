name: Release Configs

on:
  push:
    branches:
      - main  # hoặc branch bạn muốn theo dõi

jobs:
  check-release-version:
    name: Check for "Release:" in commit message
    runs-on: ubuntu-latest
    outputs:
      should_proceed: ${{ steps.check.outputs.should_proceed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check commit message
        id: check
        run: |
          echo "🔍 Checking last commit message..."

          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "📝 Commit message: $COMMIT_MSG"

          if echo "$COMMIT_MSG" | grep -q "Release:"; then
            echo "✅ Found 'Release:' in commit message."
            echo "should_proceed=true" >> $GITHUB_OUTPUT
          else
            echo "⛔ No 'Release:' found. Skipping workflow."
            echo "should_proceed=false" >> $GITHUB_OUTPUT
          fi

  zip-configs:
    name: Zip fluent-bit & redis folders
    needs: check-release-version
    if: needs.check-release-version.outputs.should_proceed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create zip file
        run: |
          ZIP_NAME=whale-sentinel-configs-${{ github.sha }}.zip
          zip -r $ZIP_NAME fluent-bit redis
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          ls -lh $ZIP_NAME

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: whale-sentinel-configs
          path: ${{ env.ZIP_NAME }}